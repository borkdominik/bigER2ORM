services:
  postgres:
    image: bigorm-postgres:16.10-alpine
    pull_policy: never
    ports:
      - 5432:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_MULTIPLE_DATABASES=java,python,csharp

  entity-framework-test:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    depends_on:
      - postgres
    working_dir: /app
    volumes:
      - ./entity-framework/entity-framework.csproj:/app/entity-framework.csproj
      - ./entity-framework/Model.cs:/app/Model.cs
      - ./entity-framework/Program.cs:/app/Program.cs
      - ./entity-framework/entity:/app/entity
    command: bash -lc "dotnet run"

  hibernate-test:
    image: maven:3.8.5-openjdk-17
    depends_on:
      - postgres
    working_dir: /app
    volumes:
      - ./hibernate/src:/app/src
      - ./hibernate/pom.xml:/app/pom.xml
    command: sh -lc "mvn -q -DskipTests compile exec:java -Dexec.mainClass=GenerateDatabase"
  
  sql-alchemy-test:
    image: python:3.10-slim
    depends_on:
      - postgres
    working_dir: /app
    volumes:
      - ./sql-alchemy/main.py:/app/main.py
      - ./sql-alchemy/base.py:/app/base.py
      - ./sql-alchemy/requirements.txt:/app/requirements.txt
      - ./sql-alchemy/__init__.py:/app/__init__.py
      - ./sql-alchemy/entity:/app/entity
    command: bash -lc "python -m pip install -q --no-cache-dir -r requirements.txt && python main.py"

  migra-runner:
    image: bigorm-migra-node:20-alpine
    pull_policy: never
    depends_on:
      entity-framework-test:
        condition: service_completed_successfully
      hibernate-test:
        condition: service_completed_successfully
      sql-alchemy-test:
        condition: service_completed_successfully
    working_dir: /app
    volumes:
      - ./schema-diffs:/app/schema-diffs